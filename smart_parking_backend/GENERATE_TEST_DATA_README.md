# 测试数据生成工具使用说明

## 功能概述

本工具用于生成智能停车系统的测试数据，包括：

1. **50个用户**：每个用户信息不同，密码统一为 `12345678`
2. **100辆车**：每个用户拥有2辆车，车辆信息各不相同
3. **100-150条停车记录**：每个用户2-3条已完成停车记录
4. **50-100条预订订单**：每个用户1-2条预订订单记录
5. **支付记录**：为已支付的预订订单和停车记录生成支付记录
6. **违规记录**：为违规停车和未使用的预订生成违规记录

## 使用前准备

### 1. 确保数据库已配置

检查 `config/config.yaml` 文件，确保数据库连接配置正确：

```yaml
database:
  host: "127.0.0.1"
  port: 3306
  user: "root"
  password: "12345"
  name: "smart_parking"
  charset: "utf8mb4"
  parseTime: true
  loc: "Local"
```

### 2. 确保已有停车场和车位数据

**重要**：在运行数据生成脚本之前，必须确保数据库中已有：
- 至少1个停车场（`parking_lot` 表）
- 至少1个车位（`parking_space` 表）

如果还没有，请先执行 `testdatai_nsert.md` 中的 SQL 语句创建停车场和车位。

### 3. 确保数据库服务运行

确保 MySQL 数据库服务正在运行。

## 使用方法

### 方法一：使用 Shell 脚本（推荐）

```bash
cd smart_parking_backend
./generate_test_data.sh
```

脚本会自动：
- 检查环境
- 提示确认
- 编译并运行 Go 程序
- 显示生成结果

### 方法二：直接运行 Go 程序

```bash
cd smart_parking_backend
go run generate_test_data.go
```

## 生成的数据说明

### 用户信息

- **用户名格式**：`user001`, `user002`, ..., `user050`
- **手机号格式**：`13810000001`, `13810000002`, ..., `13810000050`
- **密码**：所有用户密码均为 `12345678`
- **邮箱格式**：`user001@example.com`, `user002@example.com`, ...
- **真实姓名**：随机生成的中文姓名

### 车辆信息

- **车牌号**：随机生成，格式为 `省份简称 + 字母 + 5位数字`
- **品牌**：从预设品牌列表中随机选择
- **型号**：从预设型号列表中随机选择
- **颜色**：从预设颜色列表中随机选择

### 停车记录

- **时间范围**：过去30天内的随机时间
- **停车时长**：30分钟到8小时
- **费用计算**：根据停车时长和停车场费率自动计算
- **支付状态**：随机分配（已支付/未支付）
- **违规情况**：20%的概率有违规记录

### 预订订单

- **预订时间**：过去30天内
- **预订开始时间**：预订时间后的1-7天
- **预订时长**：1-4小时
- **订单状态**：
  - 如果有对应停车记录：70%概率为"已完成"，20%概率为"使用中"，10%概率为"已预订"
  - 如果没有对应停车记录：30%概率为"已取消"，30%概率为"已预订"，20%概率为"使用中"，20%概率为"已完成"（可能违规）

### 支付记录

- **支付方式**：微信支付或支付宝（随机）
- **支付时间**：
  - 预订订单：预订后1小时内
  - 停车记录：出场后30分钟内
- **交易号**：自动生成唯一交易号

### 违规记录

- **违规类型**：
  - 超时停车（对应停车记录）
  - 预订未使用（对应预订订单）
- **罚款金额**：
  - 停车违规：停车费的0.5-2倍
  - 预订违规：预订费用的1-3倍
- **处理状态**：随机分配（已处理/未处理）

## 数据关联说明

### 预订订单与停车记录的关联

- 如果预订订单状态为"已完成"，系统会尝试查找时间相近的停车记录
- 匹配条件：同一用户、同一车辆、同一停车场，且时间差在2小时内
- 如果找到匹配记录，预订订单更可能标记为"已完成"

### 违规记录的生成

1. **停车违规**：为有违规标记的停车记录生成违规记录
2. **预订违规**：为已过期但未使用的预订订单生成违规记录

## 注意事项

1. **外键约束**：停车记录的支付记录使用原生 SQL 插入，临时禁用外键检查，这是正常的
2. **数据唯一性**：所有生成的订单号、交易号、预订编号都是唯一的
3. **时间逻辑**：所有时间都基于当前时间向前推算，确保数据的时间逻辑合理
4. **数据量**：生成的数据量较大，可能需要几分钟时间

## 故障排查

### 错误：未找到停车场

**原因**：数据库中还没有停车场数据

**解决**：先执行 `testdatai_nsert.md` 中的 SQL 语句创建停车场和车位

### 错误：数据库连接失败

**原因**：数据库配置错误或数据库服务未运行

**解决**：
1. 检查 `config/config.yaml` 中的数据库配置
2. 确保 MySQL 服务正在运行
3. 检查数据库用户名和密码是否正确

### 错误：外键约束失败

**原因**：某些关联数据不存在

**解决**：确保数据库中已有必要的关联数据（停车场、车位等）

## 生成结果示例

运行成功后，会显示类似以下的信息：

```
==========================================
数据生成完成！
==========================================
用户数量: 50
车辆数量: 100
停车记录: 125
预订订单: 75
支付记录: 95
违规记录: 30

所有用户密码: 12345678
```

## 清理测试数据

如果需要清理生成的测试数据，可以执行以下 SQL（**谨慎使用**）：

```sql
-- 删除违规记录
DELETE FROM violation_record;

-- 删除支付记录
DELETE FROM payment_record;

-- 删除预订订单
DELETE FROM reservation_order;

-- 删除停车记录
DELETE FROM parking_record;

-- 删除车辆
DELETE FROM vehicle;

-- 删除用户
DELETE FROM users_list WHERE username LIKE 'user%';
```

**警告**：执行清理操作前请备份数据库！

